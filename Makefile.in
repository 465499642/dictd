# Makefile.in -- Makefile for dict
# Created: Wed Apr 24 14:14:09 1996 by faith@cs.unc.edu
# Revised: Sun Feb 22 06:08:19 1998 by faith@acm.org
# Copyright 1996, 1997, 1998 Rickard E. Faith (faith@acm.org)
# 
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 1, or (at your option) any
# later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 675 Mass Ave, Cambridge, MA 02139, USA.
# 
# $Id: Makefile.in,v 1.28 1998/02/22 13:44:46 faith Exp $
#

# Add a _letter_ if you change the version number and release your own version.
# Numbers are for the original author(s) only.
DICT_VERSION=1.4.5

ifneq (,)
This makefile requires GNU Make.
endif

.SUFFIXES:	

srcdir=		@srcdir@
VPATH=		@srcdir@
prefix=		@prefix@
subdirs=        @allsubdirs@ regex # doc -- use rfc2229 instead
exec_prefix=	@exec_prefix@
man1_prefix=	$(prefix)/man/man1
man8_prefix=	$(prefix)/man/man8
bindir=         @bindir@
sbindir=        @sbindir@
pid=            @piddir@/dictd.pid
conf=           @etcdir@/

SHELL=		/bin/sh

CC=		@CC@
CPP=		@CPP@
RANLIB=		@RANLIB@
INSTALL=	@INSTALL@
INSTALL_PROGRAM=@INSTALL_PROGRAM@
INSTALL_DATA=	@INSTALL_DATA@
LEX=		@LEX@
LEXLIB= 	@LEXLIB@
YACC=		@YACC@

CFLAGS=		@CFLAGS@ -DDICT_VERSION=\"$(DICT_VERSION)\" \
		-DDICT_CONFIG_PATH=\"$(conf)\" -DDICTD_PID_FILE=\"$(pid)\"
LDFLAGS=        @LDFLAGS@
XTRACFLAGS=     @WCFLAGS@ @XTRACFLAGS@ @DEFS@ @CPPFLAGS@ -I. -Iregex
XTRALDFLAGS=    @WLDFLAGS@ @XTRALDFLAGS@
LDLIBS=		@LIBS@ -Lregex -lregex

EXES=	 	dict dictd dictzip

HEADERS= 	./config.h @XTRAHEADERS@ dictzip.h dictd.h dict.h codes.h md5.h

SRCHOBJS=       index.o data.o
NETOBJS=        daemon.o net.o servscan.o servparse.o md5.o
CLIOBJS=        net.o clientscan.o clientparse.o md5.o

TMPS=           servscan.c servparse.c servparse.h \
		clientscan.c clientparse.c clientparse.h

all $(EXES)::
	@for subdir in $(subdirs); do \
		echo making in $$subdir; \
	 	if [ "$$subdir" = "zlib" ]; then \
			(cd $$subdir \
			&& $(MAKE) CC="$(CC)" CFLAGS="$(CFLAGS)" libz.a) \
			|| exit 1; \
		elif [ "$$subdir" = "regex" ]; then \
			(cd $$subdir \
			&& $(MAKE) CC="$(CC) $(CFLAGS)" lib) \
			|| exit 1; \
		else \
			(cd $$subdir && $(MAKE)) || exit 1; \
		fi \
	done

all:: $(EXES)

%.o: %.c
	$(CC) -c $(XTRACFLAGS) $(CFLAGS) $<

ALLFLAGS=$(XTRACFLAGS) $(CFLAGS) $(XTRALDFLAGS) $(LDFLAGS)
%: %.c
	$(CC) $(ALLFLAGS) -o $@ $< $(OBJS) $(LDLIBS)

$(SRCHOBJS):  $(HEADERS)
$(NETOBJS):  $(HEADERS)
$(CLIOBJS):  $(HEADERS)

dict:: dict.c $(HEADERS) $(CLIOBJS)
	$(CC) $(ALLFLAGS) -o $@ $< $(CLIOBJS) $(LDLIBS)

dictd:: dictd.c $(HEADERS) $(NETOBJS) $(SRCHOBJS)
	$(CC) $(ALLFLAGS) -o $@ $< $(NETOBJS) $(SRCHOBJS) $(ZIPOBJS) $(LDLIBS)

dictzip:: dictzip.c $(HEADERS) $(SRCHOBJS)
	$(CC) $(ALLFLAGS) -o $@ $< $(SRCHOBJS) $(LDLIBS)

servscan.c: servscan.l
	$(LEX) $(LFLAGS) -o$@ $<

servscan.o: servscan.c servparse.o servparse.h $(HEADERS)
	$(CC) -c $(XTRACFLAGS) $(CFLAGS) -Wno-unused $<

servparse.c: servparse.y
	$(YACC) -tdv $<
	cmp -s y.tab.h servparse.h || mv y.tab.h servparse.h
	cmp -s y.tab.c servparse.c || mv y.tab.c servparse.c
	-rm -f y.tab.h y.tab.c

servparse.o: servparse.c $(HEADERS)
	$(CC) -c $(XTRACFLAGS) $(CFLAGS) -Wno-implicit $<

clientscan.c: clientscan.l
	$(LEX) $(LFLAGS) -o$@ $<

clientscan.o: clientscan.c clientparse.o clientparse.h $(HEADERS)
	$(CC) -c $(XTRACFLAGS) $(CFLAGS) -Wno-unused $<

clientparse.c: clientparse.y
	$(YACC) -tdv $<
	cmp -s y.tab.h clientparse.h || mv y.tab.h clientparse.h
	cmp -s y.tab.c clientparse.c || mv y.tab.c clientparse.c
	-rm -f y.tab.h y.tab.c

clientparse.o: clientparse.c $(HEADERS)
	$(CC) -c $(XTRACFLAGS) $(CFLAGS) -Wno-implicit $<

install.dict: dict
	install dict $(bindir)
	install -m 644 dict.1 $(man1_prefix)

install.dictzip: dictzip
	install dictzip $(bindir)
	install -m 644 dictzip.1 $(man1_prefix)

install.dictd: dictd
	install dictd $(sbindir)
	install -m 644 dictd.8 $(man8_prefix)

install: $(EXES) install.dict install.dictzip install.dictd

.PHONY: ChangeLog
ChangeLog:
	@(echo "***** Making new ChangeLog..."; \
	rm -f ChangeLog; \
	AWK=gawk rcs2log -i 2 -r -l . doc regex zlib \
		| sed 's,/[^ ]*/libmaa/,libmaa/,g' > ChangeLog;)


dist: ChangeLog
	@( CVSROOT=`cat CVS/Root`; LIBMAACVSROOT=`cat libmaa/CVS/Root`; \
	export CVSROOT; \
	export LIBMAACVSROOT; \
	VERSION=$(DICT_VERSION) ; \
	export VERSION; \
	echo "***** Copying ChangeLog for dictd-$${VERSION}..."; \
	cp ChangeLog /tmp; \
	echo "***** Exporting files for dictd-$${VERSION}..."; \
	cd /tmp; \
	rm -rf /tmp/dictd-$${VERSION}; \
	cvs export -fNd dictd-$${VERSION} -r HEAD dictd; \
	cd dictd-$${VERSION}; \
	echo "***** Exporting files for libmaa..."; \
	cvs -d $${LIBMAACVSROOT} export -fNd libmaa -r HEAD libmaa; \
	make -f Makefile.conf; \
	mv ../ChangeLog .; \
	cd ..; \
	echo "***** Taring and zipping dictd-$${VERSION}.tar.gz..."; \
	tar cvvf dictd-$${VERSION}.tar dictd-$${VERSION}; \
	gzip -9f dictd-$${VERSION}.tar; \
	echo "***** Done making /tmp/dictd-$${VERSION}.tar.gz")

.PHONY: clean distclean tags
clean:
	-rm -f *.o *.s *~ core a.out config.log $(EXES) $(TMPS)
	-rm -f *.log *.aux *.toc *.dvi *.ps
	-rm -f *.cfg *.dtk .inslog tca.map
	-rm -f *.dct *.idx y.output

recursive-clean: clean
	@for subdir in $(subdirs); do \
		echo making clean in $$subdir; \
		(cd $$subdir && $(MAKE) clean) || exit 1; \
	done

distclean: clean
	@for subdir in $(subdirs); do \
	 	if [ "$$subdir" != "zlib" ]; then \
			if [ "$$subdir" = "regex" ]; then \
				echo making clean in $$subdir; \
				(cd $$subdir && $(MAKE) clean) || exit 1; \
			else \
				echo making $@ in $$subdir; \
				(cd $$subdir && $(MAKE) $@) || exit 1; \
			fi \
		fi \
	done
	-rm -f regex/regex.h
	-rm -f config.h config.cache config.status stamp-h.in stamp-h
	-rm -f configure Makefile

tags:
	etags *.[ch]


# The following is based on the "Automatic Remaking" node in the GNU
# Autoconf documentation:

$(srcdir)/configure: configure.in
	cd $(srcdir) && autoconf

# autoheader might not change config.h.in, so touch a stamp file.
${srcdir}/config.h.in: stamp-h.in
${srcdir}/stamp-h.in: configure.in
	cd ${srcdir} && autoheader
	date > ${srcdir}/stamp-h.in

config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

